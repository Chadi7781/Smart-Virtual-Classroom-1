{"ast":null,"code":"var _jsxFileName = \"C:\\\\Smart-Virtual-Classroom\\\\client\\\\src\\\\Components\\\\Room\\\\Room.js\",\n    _s = $RefreshSig$();\n\nimport React, { useState, useEffect, useRef } from \"react\";\nimport Peer from \"simple-peer\";\nimport styled from \"styled-components\";\nimport socket from \"../../socket\";\nimport VideoCard from \"../Video/VideoCard\";\nimport BottomBar from \"../BottomBar/BottomBar\";\nimport Chat from \"../Chat/Chat\";\nimport ScreenRecord from \"../coursesAndSeances/ScreenRecord\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst Room = props => {\n  _s();\n\n  const currentUser = sessionStorage.getItem(\"user\");\n  const [peers, setPeers] = useState([]);\n  const [userslist, setuserslist] = useState([]);\n  const [userVideoAudio, setUserVideoAudio] = useState({\n    localUser: {\n      video: true,\n      audio: true\n    }\n  });\n  const [videoDevices, setVideoDevices] = useState([]);\n  const [displayChat, setDisplayChat] = useState(false);\n  const [screenShare, setScreenShare] = useState(false);\n  const [showVideoDevices, setShowVideoDevices] = useState(false);\n  const peersRef = useRef([]);\n  const userVideoRef = useRef();\n  const screenTrackRef = useRef();\n  const userStream = useRef();\n  const roomId = props.match.params.roomId;\n  useEffect(() => {\n    // Get Video Devices\n    navigator.mediaDevices.enumerateDevices().then(devices => {\n      const filtered = devices.filter(device => device.kind === \"videoinput\");\n      setVideoDevices(filtered);\n    }); // Set Back Button Event\n\n    window.addEventListener(\"popstate\", goToBack); // Connect Camera & Mic\n\n    navigator.mediaDevices.getUserMedia({\n      video: true,\n      audio: true\n    }).then(stream => {\n      userVideoRef.current.srcObject = stream;\n      userStream.current = stream;\n      socket.emit(\"BE-join-room\", {\n        roomId,\n        userName: currentUser\n      });\n      socket.on(\"FE-user-join\", users => {\n        console.log(\"users from room : \" + users);\n        setuserslist(users); // all users\n\n        const peers = [];\n        users.forEach(({\n          userId,\n          info\n        }) => {\n          let {\n            userName,\n            video,\n            audio\n          } = info;\n\n          if (userName !== currentUser) {\n            const peer = createPeer(userId, socket.id, stream);\n            peer.userName = userName;\n            peer.peerID = userId;\n            peersRef.current.push({\n              peerID: userId,\n              peer,\n              userName\n            });\n            peers.push(peer);\n            setUserVideoAudio(preList => {\n              return { ...preList,\n                [peer.userName]: {\n                  video,\n                  audio\n                }\n              };\n            });\n          }\n        });\n        setPeers(peers);\n      }); //\n\n      socket.on(\"FE-receive-call\", ({\n        signal,\n        from,\n        info\n      }) => {\n        let {\n          userName,\n          video,\n          audio\n        } = info;\n        const peerIdx = findPeer(from);\n\n        if (!peerIdx) {\n          const peer = addPeer(signal, from, stream);\n          peer.userName = userName;\n          peersRef.current.push({\n            peerID: from,\n            peer,\n            userName: userName\n          });\n          setPeers(users => {\n            return [...users, peer];\n          });\n          setUserVideoAudio(preList => {\n            return { ...preList,\n              [peer.userName]: {\n                video,\n                audio\n              }\n            };\n          });\n        }\n      });\n      socket.on(\"FE-call-accepted\", ({\n        signal,\n        answerId\n      }) => {\n        const peerIdx = findPeer(answerId);\n        peerIdx.peer.signal(signal);\n      });\n      socket.on(\"FE-user-leave\", ({\n        userId,\n        userName\n      }) => {\n        const peerIdx = findPeer(userId);\n        peerIdx.peer.destroy();\n        setPeers(users => {\n          users = users.filter(user => user.peerID !== peerIdx.peer.peerID);\n          setuserslist(users);\n          return [...users];\n        });\n        console.log(\"ici users list AFTER LEAVE : \" + JSON.stringify(userslist));\n      });\n    });\n    socket.on(\"FE-toggle-camera\", ({\n      userId,\n      switchTarget\n    }) => {\n      const peerIdx = findPeer(userId);\n      setUserVideoAudio(preList => {\n        let video = preList[peerIdx.userName].video;\n        let audio = preList[peerIdx.userName].audio;\n        if (switchTarget === \"video\") video = !video;else audio = !audio;\n        return { ...preList,\n          [peerIdx.userName]: {\n            video,\n            audio\n          }\n        };\n      });\n    });\n    /* return () => {\r\n       socket.disconnect();\r\n     };*/\n    // eslint-disable-next-line\n  }, []);\n\n  function createPeer(userId, caller, stream) {\n    const peer = new Peer({\n      initiator: true,\n      trickle: false,\n      stream\n    });\n    peer.on(\"signal\", signal => {\n      socket.emit(\"BE-call-user\", {\n        userToCall: userId,\n        from: caller,\n        signal\n      });\n    });\n    peer.on(\"disconnect\", () => {\n      peer.destroy();\n    });\n    return peer;\n  }\n\n  function addPeer(incomingSignal, callerId, stream) {\n    const peer = new Peer({\n      initiator: false,\n      trickle: false,\n      stream\n    });\n    peer.on(\"signal\", signal => {\n      socket.emit(\"BE-accept-call\", {\n        signal,\n        to: callerId\n      });\n    });\n    peer.on(\"disconnect\", () => {\n      peer.destroy();\n    });\n    peer.signal(incomingSignal);\n    return peer;\n  }\n\n  function findPeer(id) {\n    return peersRef.current.find(p => p.peerID === id);\n  }\n\n  function createUserVideo(peer, index, arr) {\n    return /*#__PURE__*/_jsxDEV(VideoBox, {\n      className: `width-peer${peers.length > 8 ? \"\" : peers.length}`,\n      onClick: expandScreen,\n      children: [writeUserName(peer.userName), /*#__PURE__*/_jsxDEV(FaIcon, {\n        className: \"fas fa-expand\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 206,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(VideoCard, {\n        peer: peer,\n        number: arr.length\n      }, index, false, {\n        fileName: _jsxFileName,\n        lineNumber: 207,\n        columnNumber: 9\n      }, this)]\n    }, index, true, {\n      fileName: _jsxFileName,\n      lineNumber: 200,\n      columnNumber: 7\n    }, this);\n  }\n\n  function writeUserName(userName, index) {\n    if (userVideoAudio.hasOwnProperty(userName)) {\n      if (!userVideoAudio[userName].video) {\n        return /*#__PURE__*/_jsxDEV(UserName, {\n          children: userName\n        }, userName, false, {\n          fileName: _jsxFileName,\n          lineNumber: 215,\n          columnNumber: 16\n        }, this);\n      }\n    }\n  } // Open Chat\n\n\n  const clickChat = e => {\n    e.stopPropagation();\n    setDisplayChat(!displayChat);\n  }; // BackButton\n\n\n  const goToBack = e => {\n    e.preventDefault();\n    socket.emit(\"BE-leave-room\", {\n      roomId,\n      leaver: currentUser\n    });\n    sessionStorage.removeItem(\"user\");\n    window.location.href = \"/stream\";\n  };\n\n  const toggleCameraAudio = e => {\n    const target = e.target.getAttribute(\"data-switch\");\n    setUserVideoAudio(preList => {\n      let videoSwitch = preList[\"localUser\"].video;\n      let audioSwitch = preList[\"localUser\"].audio;\n\n      if (target === \"video\") {\n        const userVideoTrack = userVideoRef.current.srcObject.getVideoTracks()[0];\n        videoSwitch = !videoSwitch;\n        userVideoTrack.enabled = videoSwitch;\n      } else {\n        const userAudioTrack = userVideoRef.current.srcObject.getAudioTracks()[0];\n        audioSwitch = !audioSwitch;\n\n        if (userAudioTrack) {\n          userAudioTrack.enabled = audioSwitch;\n        } else {\n          userStream.current.getAudioTracks()[0].enabled = audioSwitch;\n        }\n      }\n\n      return { ...preList,\n        localUser: {\n          video: videoSwitch,\n          audio: audioSwitch\n        }\n      };\n    });\n    socket.emit(\"BE-toggle-camera-audio\", {\n      roomId,\n      switchTarget: target\n    });\n  };\n\n  const clickScreenSharing = () => {\n    if (!screenShare) {\n      navigator.mediaDevices.getDisplayMedia({\n        cursor: true\n      }).then(stream => {\n        const screenTrack = stream.getTracks()[0];\n        peersRef.current.forEach(({\n          peer\n        }) => {\n          // replaceTrack (oldTrack, newTrack, oldStream);\n          peer.replaceTrack(peer.streams[0].getTracks().find(track => track.kind === \"video\"), screenTrack, userStream.current);\n        }); // Listen click end\n\n        screenTrack.onended = () => {\n          peersRef.current.forEach(({\n            peer\n          }) => {\n            peer.replaceTrack(screenTrack, peer.streams[0].getTracks().find(track => track.kind === \"video\"), userStream.current);\n          });\n          userVideoRef.current.srcObject = userStream.current;\n          setScreenShare(false);\n        };\n\n        userVideoRef.current.srcObject = stream;\n        screenTrackRef.current = screenTrack;\n        setScreenShare(true);\n      });\n    } else {\n      screenTrackRef.current.onended();\n    }\n  };\n\n  const expandScreen = e => {\n    const elem = e.target;\n\n    if (elem.requestFullscreen) {\n      elem.requestFullscreen();\n    } else if (elem.mozRequestFullScreen) {\n      /* Firefox */\n      elem.mozRequestFullScreen();\n    } else if (elem.webkitRequestFullscreen) {\n      /* Chrome, Safari & Opera */\n      elem.webkitRequestFullscreen();\n    } else if (elem.msRequestFullscreen) {\n      /* IE/Edge */\n      elem.msRequestFullscreen();\n    }\n  };\n\n  const clickBackground = () => {\n    if (!showVideoDevices) return;\n    setShowVideoDevices(false);\n  };\n\n  return /*#__PURE__*/_jsxDEV(AppContainer, {\n    children: /*#__PURE__*/_jsxDEV(RoomContainer, {\n      onClick: clickBackground,\n      children: [/*#__PURE__*/_jsxDEV(VideoAndBarContainer, {\n        children: [/*#__PURE__*/_jsxDEV(VideoContainer, {\n          children: [/*#__PURE__*/_jsxDEV(VideoBox, {\n            className: `width-peer${peers.length > 8 ? \"\" : peers.length}`,\n            children: [userVideoAudio[\"localUser\"].video ? null : /*#__PURE__*/_jsxDEV(UserName, {\n              children: currentUser\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 340,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(FaIcon, {\n              className: \"fas fa-expand\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 342,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(MyVideo, {\n              onClick: expandScreen,\n              ref: userVideoRef,\n              muted: true,\n              autoPlay: true,\n              playInline: true\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 343,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 336,\n            columnNumber: 13\n          }, this), peers && peers.map((peer, index, arr) => createUserVideo(peer, index, arr))]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 334,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(BottomBar, {\n          clickScreenSharing: clickScreenSharing,\n          clickChat: clickChat,\n          goToBack: goToBack,\n          toggleCameraAudio: toggleCameraAudio,\n          userVideoAudio: userVideoAudio[\"localUser\"],\n          screenShare: screenShare,\n          videoDevices: videoDevices,\n          showVideoDevices: showVideoDevices,\n          setShowVideoDevices: setShowVideoDevices,\n          listuserRoom: userslist\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 357,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 333,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Chat, {\n        display: displayChat,\n        roomId: roomId\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 370,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 332,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 331,\n    columnNumber: 5\n  }, this);\n};\n\n_s(Room, \"MwcIyK+XLR1DrNEBKb7KFS6Sf+I=\");\n\n_c = Room;\nconst AppContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  align-items: center;\n  justify-content: center;\n  font-size: calc(8px + 2vmin);\n  background-color: #454552;\n  color: white;\n  text-align: center;\n`;\n_c2 = AppContainer;\nconst RoomContainer = styled.div`\n  display: flex;\n  width: 100%;\n  max-height: 100vh;\n  flex-direction: row;\n`;\n_c3 = RoomContainer;\nconst VideoContainer = styled.div`\n  max-width: 100%;\n  height: 92%;\n  display: flex;\n  flex-direction: row;\n  justify-content: space-around;\n  flex-wrap: wrap;\n  align-items: center;\n  padding: 15px;\n  box-sizing: border-box;\n  gap: 10px;\n`;\n_c4 = VideoContainer;\nconst VideoAndBarContainer = styled.div`\n  position: relative;\n  width: 100%;\n  height: 100vh;\n`;\n_c5 = VideoAndBarContainer;\nconst MyVideo = styled.video``;\n_c6 = MyVideo;\nconst VideoBox = styled.div`\n  position: relative;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  > video {\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n  }\n\n  :hover {\n    > i {\n      display: block;\n    }\n  }\n`;\n_c7 = VideoBox;\nconst UserName = styled.div`\n  position: absolute;\n  font-size: calc(20px + 5vmin);\n  z-index: 1;\n`;\n_c8 = UserName;\nconst FaIcon = styled.i`\n  display: none;\n  position: absolute;\n  right: 15px;\n  top: 15px;\n`;\n_c9 = FaIcon;\nexport default Room;\n\nvar _c, _c2, _c3, _c4, _c5, _c6, _c7, _c8, _c9;\n\n$RefreshReg$(_c, \"Room\");\n$RefreshReg$(_c2, \"AppContainer\");\n$RefreshReg$(_c3, \"RoomContainer\");\n$RefreshReg$(_c4, \"VideoContainer\");\n$RefreshReg$(_c5, \"VideoAndBarContainer\");\n$RefreshReg$(_c6, \"MyVideo\");\n$RefreshReg$(_c7, \"VideoBox\");\n$RefreshReg$(_c8, \"UserName\");\n$RefreshReg$(_c9, \"FaIcon\");","map":{"version":3,"sources":["C:/Smart-Virtual-Classroom/client/src/Components/Room/Room.js"],"names":["React","useState","useEffect","useRef","Peer","styled","socket","VideoCard","BottomBar","Chat","ScreenRecord","Room","props","currentUser","sessionStorage","getItem","peers","setPeers","userslist","setuserslist","userVideoAudio","setUserVideoAudio","localUser","video","audio","videoDevices","setVideoDevices","displayChat","setDisplayChat","screenShare","setScreenShare","showVideoDevices","setShowVideoDevices","peersRef","userVideoRef","screenTrackRef","userStream","roomId","match","params","navigator","mediaDevices","enumerateDevices","then","devices","filtered","filter","device","kind","window","addEventListener","goToBack","getUserMedia","stream","current","srcObject","emit","userName","on","users","console","log","forEach","userId","info","peer","createPeer","id","peerID","push","preList","signal","from","peerIdx","findPeer","addPeer","answerId","destroy","user","JSON","stringify","switchTarget","caller","initiator","trickle","userToCall","incomingSignal","callerId","to","find","p","createUserVideo","index","arr","length","expandScreen","writeUserName","hasOwnProperty","clickChat","e","stopPropagation","preventDefault","leaver","removeItem","location","href","toggleCameraAudio","target","getAttribute","videoSwitch","audioSwitch","userVideoTrack","getVideoTracks","enabled","userAudioTrack","getAudioTracks","clickScreenSharing","getDisplayMedia","cursor","screenTrack","getTracks","replaceTrack","streams","track","onended","elem","requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen","clickBackground","map","AppContainer","div","RoomContainer","VideoContainer","VideoAndBarContainer","MyVideo","VideoBox","UserName","FaIcon","i"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from \"react\";\r\nimport Peer from \"simple-peer\";\r\nimport styled from \"styled-components\";\r\nimport socket from \"../../socket\";\r\nimport VideoCard from \"../Video/VideoCard\";\r\nimport BottomBar from \"../BottomBar/BottomBar\";\r\nimport Chat from \"../Chat/Chat\";\r\nimport ScreenRecord from \"../coursesAndSeances/ScreenRecord\";\r\n\r\nconst Room = (props) => {\r\n  const currentUser = sessionStorage.getItem(\"user\");\r\n  const [peers, setPeers] = useState([]);\r\n  const [userslist, setuserslist] = useState([]);\r\n\r\n  const [userVideoAudio, setUserVideoAudio] = useState({\r\n    localUser: { video: true, audio: true },\r\n  });\r\n  const [videoDevices, setVideoDevices] = useState([]);\r\n  const [displayChat, setDisplayChat] = useState(false);\r\n  const [screenShare, setScreenShare] = useState(false);\r\n  const [showVideoDevices, setShowVideoDevices] = useState(false);\r\n  const peersRef = useRef([]);\r\n  const userVideoRef = useRef();\r\n  const screenTrackRef = useRef();\r\n  const userStream = useRef();\r\n  const roomId = props.match.params.roomId;\r\n\r\n  useEffect(() => {\r\n    // Get Video Devices\r\n    navigator.mediaDevices.enumerateDevices().then((devices) => {\r\n      const filtered = devices.filter((device) => device.kind === \"videoinput\");\r\n      setVideoDevices(filtered);\r\n    });\r\n\r\n    // Set Back Button Event\r\n    window.addEventListener(\"popstate\", goToBack);\r\n\r\n    // Connect Camera & Mic\r\n    navigator.mediaDevices\r\n      .getUserMedia({ video: true, audio: true })\r\n      .then((stream) => {\r\n        userVideoRef.current.srcObject = stream;\r\n        userStream.current = stream;\r\n\r\n        socket.emit(\"BE-join-room\", { roomId, userName: currentUser });\r\n        socket.on(\"FE-user-join\", (users) => {\r\n          console.log(\"users from room : \"+users);\r\n          setuserslist(users);\r\n          // all users\r\n          const peers = [];\r\n          users.forEach(({ userId, info }) => {\r\n            let { userName, video, audio } = info;\r\n\r\n            if (userName !== currentUser) {\r\n              const peer = createPeer(userId, socket.id, stream);\r\n\r\n              peer.userName = userName;\r\n              peer.peerID = userId;\r\n\r\n              peersRef.current.push({\r\n                peerID: userId,\r\n                peer,\r\n                userName,\r\n              });\r\n              peers.push(peer);\r\n\r\n              setUserVideoAudio((preList) => {\r\n                return {\r\n                  ...preList,\r\n                  [peer.userName]: { video, audio },\r\n                };\r\n              });\r\n            }\r\n          });\r\n\r\n          setPeers(peers);\r\n        });\r\n        //\r\n        socket.on(\"FE-receive-call\", ({ signal, from, info }) => {\r\n          let { userName, video, audio } = info;\r\n          const peerIdx = findPeer(from);\r\n\r\n          if (!peerIdx) {\r\n            const peer = addPeer(signal, from, stream);\r\n\r\n            peer.userName = userName;\r\n\r\n            peersRef.current.push({\r\n              peerID: from,\r\n              peer,\r\n              userName: userName,\r\n            });\r\n            setPeers((users) => {\r\n              return [...users, peer];\r\n            });\r\n            setUserVideoAudio((preList) => {\r\n              return {\r\n                ...preList,\r\n                [peer.userName]: { video, audio },\r\n              };\r\n            });\r\n          }\r\n        });\r\n\r\n        socket.on(\"FE-call-accepted\", ({ signal, answerId }) => {\r\n          const peerIdx = findPeer(answerId);\r\n          peerIdx.peer.signal(signal);\r\n        });\r\n\r\n        socket.on(\"FE-user-leave\", ({ userId, userName }) => {\r\n          const peerIdx = findPeer(userId);\r\n          peerIdx.peer.destroy();\r\n         \r\n          setPeers((users) => {\r\n            users = users.filter((user) => user.peerID !== peerIdx.peer.peerID);\r\n            setuserslist(users);\r\n            return [...users];\r\n          });\r\n          console.log(\"ici users list AFTER LEAVE : \"+JSON.stringify(userslist))\r\n\r\n        });\r\n      });\r\n\r\n    socket.on(\"FE-toggle-camera\", ({ userId, switchTarget }) => {\r\n      const peerIdx = findPeer(userId);\r\n\r\n      setUserVideoAudio((preList) => {\r\n        let video = preList[peerIdx.userName].video;\r\n        let audio = preList[peerIdx.userName].audio;\r\n\r\n        if (switchTarget === \"video\") video = !video;\r\n        else audio = !audio;\r\n\r\n        return {\r\n          ...preList,\r\n          [peerIdx.userName]: { video, audio },\r\n        };\r\n      });\r\n    });\r\n\r\n   /* return () => {\r\n      socket.disconnect();\r\n    };*/\r\n    // eslint-disable-next-line\r\n  }, []);\r\n\r\n  function createPeer(userId, caller, stream) {\r\n    const peer = new Peer({\r\n\r\n    \r\n      initiator: true,\r\n      trickle: false,\r\n      stream,\r\n    });\r\n   \r\n \r\n    peer.on(\"signal\", (signal) => {\r\n      socket.emit(\"BE-call-user\", {\r\n        userToCall: userId,\r\n        from: caller,\r\n        signal,\r\n      });\r\n    });\r\n    peer.on(\"disconnect\", () => {\r\n      peer.destroy();\r\n    });\r\n   \r\n    return peer;\r\n  }\r\n\r\n  function addPeer(incomingSignal, callerId, stream) {\r\n    const peer = new Peer({\r\n     \r\n      initiator: false,\r\n      trickle: false,\r\n      stream,\r\n    });\r\n   \r\n \r\n    \r\n    peer.on(\"signal\", (signal) => {\r\n      socket.emit(\"BE-accept-call\", { signal, to: callerId });\r\n    });\r\n\r\n    peer.on(\"disconnect\", () => {\r\n      peer.destroy();\r\n    });\r\n\r\n    peer.signal(incomingSignal);\r\n\r\n    return peer;\r\n  }\r\n\r\n  function findPeer(id) {\r\n    return peersRef.current.find((p) => p.peerID === id);\r\n  }\r\n\r\n  function createUserVideo(peer, index, arr) {\r\n    return (\r\n      <VideoBox\r\n        className={`width-peer${peers.length > 8 ? \"\" : peers.length}`}\r\n        onClick={expandScreen}\r\n        key={index}\r\n      >\r\n        {writeUserName(peer.userName)}\r\n        <FaIcon className=\"fas fa-expand\" />\r\n        <VideoCard key={index} peer={peer} number={arr.length} />\r\n      </VideoBox>\r\n    );\r\n  }\r\n\r\n  function writeUserName(userName, index) {\r\n    if (userVideoAudio.hasOwnProperty(userName)) {\r\n      if (!userVideoAudio[userName].video) {\r\n        return <UserName key={userName}>{userName}</UserName>;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Open Chat\r\n  const clickChat = (e) => {\r\n    e.stopPropagation();\r\n    setDisplayChat(!displayChat);\r\n  };\r\n\r\n  // BackButton\r\n  const goToBack = (e) => {\r\n    e.preventDefault();\r\n    socket.emit(\"BE-leave-room\", { roomId, leaver: currentUser });\r\n    sessionStorage.removeItem(\"user\");\r\n    window.location.href = \"/stream\";\r\n  };\r\n\r\n  const toggleCameraAudio = (e) => {\r\n    const target = e.target.getAttribute(\"data-switch\");\r\n\r\n    setUserVideoAudio((preList) => {\r\n      let videoSwitch = preList[\"localUser\"].video;\r\n      let audioSwitch = preList[\"localUser\"].audio;\r\n\r\n      if (target === \"video\") {\r\n        const userVideoTrack = userVideoRef.current.srcObject.getVideoTracks()[0];\r\n        videoSwitch = !videoSwitch;\r\n        userVideoTrack.enabled = videoSwitch;\r\n      } else {\r\n        const userAudioTrack = userVideoRef.current.srcObject.getAudioTracks()[0];\r\n        audioSwitch = !audioSwitch;\r\n\r\n        if (userAudioTrack) {\r\n          userAudioTrack.enabled = audioSwitch;\r\n        } else {\r\n          userStream.current.getAudioTracks()[0].enabled = audioSwitch;\r\n        }\r\n      }\r\n\r\n      return {\r\n        ...preList,\r\n        localUser: { video: videoSwitch, audio: audioSwitch },\r\n      };\r\n    });\r\n\r\n    socket.emit(\"BE-toggle-camera-audio\", { roomId, switchTarget: target });\r\n  };\r\n\r\n  const clickScreenSharing = () => {\r\n    if (!screenShare) {\r\n      navigator.mediaDevices\r\n        .getDisplayMedia({ cursor: true })\r\n        .then((stream) => {\r\n          const screenTrack = stream.getTracks()[0];\r\n\r\n          peersRef.current.forEach(({ peer }) => {\r\n            // replaceTrack (oldTrack, newTrack, oldStream);\r\n            peer.replaceTrack(\r\n              peer.streams[0]\r\n                .getTracks()\r\n                .find((track) => track.kind === \"video\"),\r\n              screenTrack,\r\n              userStream.current\r\n            );\r\n          });\r\n\r\n          // Listen click end\r\n          screenTrack.onended = () => {\r\n            peersRef.current.forEach(({ peer }) => {\r\n              peer.replaceTrack(\r\n                screenTrack,\r\n                peer.streams[0]\r\n                  .getTracks()\r\n                  .find((track) => track.kind === \"video\"),\r\n                userStream.current\r\n              );\r\n            });\r\n            userVideoRef.current.srcObject = userStream.current;\r\n            setScreenShare(false);\r\n          };\r\n\r\n          userVideoRef.current.srcObject = stream;\r\n          screenTrackRef.current = screenTrack;\r\n          setScreenShare(true);\r\n        });\r\n    } else {\r\n      screenTrackRef.current.onended();\r\n    }\r\n  };\r\n\r\n  const expandScreen = (e) => {\r\n    const elem = e.target;\r\n\r\n    if (elem.requestFullscreen) {\r\n      elem.requestFullscreen();\r\n    } else if (elem.mozRequestFullScreen) {\r\n      /* Firefox */\r\n      elem.mozRequestFullScreen();\r\n    } else if (elem.webkitRequestFullscreen) {\r\n      /* Chrome, Safari & Opera */\r\n      elem.webkitRequestFullscreen();\r\n    } else if (elem.msRequestFullscreen) {\r\n      /* IE/Edge */\r\n      elem.msRequestFullscreen();\r\n    }\r\n  };\r\n\r\n  const clickBackground = () => {\r\n    if (!showVideoDevices) return;\r\n\r\n    setShowVideoDevices(false);\r\n  };\r\n\r\n  return (\r\n    <AppContainer>\r\n      <RoomContainer onClick={clickBackground}>\r\n        <VideoAndBarContainer>\r\n          <VideoContainer>\r\n            {/* Current User Video */}\r\n            <VideoBox\r\n              className={`width-peer${peers.length > 8 ? \"\" : peers.length}`}\r\n            >\r\n              {userVideoAudio[\"localUser\"].video ? null : (\r\n                <UserName>{currentUser}</UserName>\r\n              )}\r\n              <FaIcon className=\"fas fa-expand\" />\r\n              <MyVideo\r\n                onClick={expandScreen}\r\n                ref={userVideoRef}\r\n                muted\r\n                autoPlay\r\n                playInline\r\n              ></MyVideo>\r\n            </VideoBox>\r\n            {/* Joined User Vidoe */}\r\n            {peers &&\r\n              peers.map((peer, index, arr) =>\r\n                createUserVideo(peer, index, arr)\r\n              )}\r\n          </VideoContainer>\r\n          <BottomBar\r\n            clickScreenSharing={clickScreenSharing}\r\n            clickChat={clickChat}\r\n            goToBack={goToBack}\r\n            toggleCameraAudio={toggleCameraAudio}\r\n            userVideoAudio={userVideoAudio[\"localUser\"]}\r\n            screenShare={screenShare}\r\n            videoDevices={videoDevices}\r\n            showVideoDevices={showVideoDevices}\r\n            setShowVideoDevices={setShowVideoDevices}\r\n            listuserRoom={userslist}\r\n          />\r\n        </VideoAndBarContainer>\r\n        <Chat display={displayChat} roomId={roomId} />\r\n      </RoomContainer>\r\n    </AppContainer>\r\n  );\r\n};\r\nconst AppContainer = styled.div`\r\n  display: flex;\r\n  flex-direction: column;\r\n  min-height: 100vh;\r\n  align-items: center;\r\n  justify-content: center;\r\n  font-size: calc(8px + 2vmin);\r\n  background-color: #454552;\r\n  color: white;\r\n  text-align: center;\r\n`;\r\nconst RoomContainer = styled.div`\r\n  display: flex;\r\n  width: 100%;\r\n  max-height: 100vh;\r\n  flex-direction: row;\r\n`;\r\n\r\nconst VideoContainer = styled.div`\r\n  max-width: 100%;\r\n  height: 92%;\r\n  display: flex;\r\n  flex-direction: row;\r\n  justify-content: space-around;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n  padding: 15px;\r\n  box-sizing: border-box;\r\n  gap: 10px;\r\n`;\r\n\r\nconst VideoAndBarContainer = styled.div`\r\n  position: relative;\r\n  width: 100%;\r\n  height: 100vh;\r\n`;\r\n\r\nconst MyVideo = styled.video``;\r\n\r\nconst VideoBox = styled.div`\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  > video {\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n  }\r\n\r\n  :hover {\r\n    > i {\r\n      display: block;\r\n    }\r\n  }\r\n`;\r\n\r\nconst UserName = styled.div`\r\n  position: absolute;\r\n  font-size: calc(20px + 5vmin);\r\n  z-index: 1;\r\n`;\r\n\r\nconst FaIcon = styled.i`\r\n  display: none;\r\n  position: absolute;\r\n  right: 15px;\r\n  top: 15px;\r\n`;\r\n\r\nexport default Room;\r\n"]},"metadata":{},"sourceType":"module"}