import{r as t,c as s,h as i}from"./p-f8abe418.js";import"./p-8acb8eb5.js";import{w as a,m as h,o as e,e as r}from"./p-29b5bd7f.js";import{w as c}from"./p-cdfa9679.js";import"./p-0cbaf141.js";import{M as o}from"./p-8b74fa0e.js";import"./p-121aab6e.js";import{h as n,b as l}from"./p-b0ea4d0d.js";import{w as p,c as d}from"./p-dff73e1a.js";import"./p-23929c27.js";import{l as u}from"./p-588e48e7.js";const y=class{constructor(i){t(this,i),this.vmLoadStart=s(this,"vmLoadStart",7),this.vmError=s(this,"vmError",7),this.hasAttached=!1,this.version="latest",this.preload="metadata",this.playbackReady=!1,a(this),p(this),c(this,["playbackReady"])}connectedCallback(){this.dispatch=d(this),this.mediaEl&&this.setupHls()}disconnectedCallback(){this.destroyHls()}get src(){if(h(this.videoProvider))return;const t=this.videoProvider.querySelectorAll("source");return Array.from(t).find((t=>n.test(t.src)||l.test(t.type)))?.src}async setupHls(){if(e(this.hls))try{const t=this.libSrc||`https://cdn.jsdelivr.net/npm/hls.js@${this.version}/dist/hls.min.js`,s=await u(t,"Hls");if(!s.isSupported())return void this.vmError.emit("hls.js is not supported");this.hls=new s(this.config),this.hls.on(s.Events.MEDIA_ATTACHED,(()=>{this.hasAttached=!0,this.onSrcChange()})),this.hls.on(s.Events.AUDIO_TRACKS_UPDATED,(()=>{this.dispatch("audioTracks",this.hls.audioTracks),this.dispatch("currentAudioTrack",this.hls.audioTrack)})),this.hls.on(s.Events.AUDIO_TRACK_SWITCHED,(()=>{this.dispatch("currentAudioTrack",this.hls.audioTrack)})),this.hls.on(s.Events.ERROR,((t,i)=>{if(i.fatal)switch(i.type){case s.ErrorTypes.NETWORK_ERROR:this.hls.startLoad();break;case s.ErrorTypes.MEDIA_ERROR:this.hls.recoverMediaError();break;default:this.destroyHls()}this.vmError.emit({event:t,data:i})})),this.hls.on(s.Events.MANIFEST_PARSED,(()=>{this.dispatch("mediaType",o.Video),this.dispatch("currentSrc",this.src),this.dispatchLevels()})),this.hls.on(s.Events.LEVEL_LOADED,((t,s)=>{this.playbackReady||(this.dispatch("duration",s.details.totalduration),this.dispatch("playbackReady",!0))})),this.hls.attachMedia(this.mediaEl)}catch(t){this.vmError.emit(t)}}dispatchLevels(){this.hls.levels&&0!==this.hls.levels.length&&(this.dispatch("playbackQualities",["Auto",...this.hls.levels.map(this.levelToPlaybackQuality)]),this.dispatch("playbackQuality","Auto"))}levelToPlaybackQuality(t){return-1===t?"Auto":t.height+"p"}findLevelIndexFromQuality(t){return this.hls.levels.findIndex((s=>this.levelToPlaybackQuality(s)===t))}destroyHls(){this.hls?.destroy(),this.hasAttached=!1}async onMediaElChange(t){this.destroyHls(),e(t.detail)||(this.mediaEl=t.detail,setTimeout((async()=>{await this.setupHls()}),50))}async onSrcChange(){this.hasAttached&&this.hls.url!==this.src&&(this.vmLoadStart.emit(),this.hls.loadSource(this.src))}async getAdapter(){const t=await(this.videoProvider?.getAdapter())??{},s=t.canPlay;return{...t,getInternalPlayer:async()=>this.hls,canPlay:async t=>r(t)&&n.test(t)||(s?.(t)??!1),canSetPlaybackQuality:async()=>this.hls?.levels?.length>0,setPlaybackQuality:async t=>{e(this.hls)||(this.hls.currentLevel=this.findLevelIndexFromQuality(t),this.dispatch("playbackQuality",t))},setCurrentAudioTrack:async t=>{e(this.hls)||(this.hls.audioTrack=t)}}}render(){return i("vm-video",{willAttach:!0,crossOrigin:this.crossOrigin,preload:this.preload,poster:this.poster,controlsList:this.controlsList,autoPiP:this.autoPiP,disablePiP:this.disablePiP,disableRemotePlayback:this.disableRemotePlayback,mediaTitle:this.mediaTitle,ref:t=>{this.videoProvider=t}},i("slot",null))}};export{y as vm_hls}