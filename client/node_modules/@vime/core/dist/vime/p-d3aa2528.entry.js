import{r as t,c as s,h as i}from"./p-f8abe418.js";import"./p-8acb8eb5.js";import{D as h,w as a,o as e,l as r,e as c}from"./p-29b5bd7f.js";import{w as n}from"./p-cdfa9679.js";import"./p-0cbaf141.js";import{M as o}from"./p-8b74fa0e.js";import"./p-121aab6e.js";import{d}from"./p-b0ea4d0d.js";import{w as l,c as T}from"./p-dff73e1a.js";import"./p-23929c27.js";import{l as u}from"./p-588e48e7.js";const p=class{constructor(i){t(this,i),this.vmLoadStart=s(this,"vmLoadStart",7),this.vmError=s(this,"vmError",7),this.textTracksDisposal=new h,this.hasAttached=!1,this.version="latest",this.config={},this.autoplay=!1,this.preload="metadata",this.enableTextTracksByDefault=!0,this.shouldRenderNativeTextTracks=!0,this.isTextTrackVisible=!0,this.currentTextTrack=-1,a(this),l(this),n(this,["autoplay","shouldRenderNativeTextTracks","isTextTrackVisible","currentTextTrack"])}onSrcChange(){this.hasAttached&&(this.vmLoadStart.emit(),this.dash.attachSource(this.src))}onShouldRenderNativeTextTracks(){this.shouldRenderNativeTextTracks?this.textTracksDisposal.empty():this.hideCurrentTextTrack(),this.dash?.enableForcedTextStreaming(!this.shouldRenderNativeTextTracks)}onTextTrackChange(){!this.shouldRenderNativeTextTracks||e(this.dash)||(this.dash.setTextTrack(this.isTextTrackVisible?this.currentTextTrack:-1),this.isTextTrackVisible)||"hidden"===Array.from(this.mediaEl?.textTracks??[])[this.currentTextTrack]?.mode&&this.dispatch("currentTextTrack",-1)}connectedCallback(){this.dispatch=T(this),this.mediaEl&&this.setupDash()}disconnectedCallback(){this.textTracksDisposal.empty(),this.destroyDash()}async setupDash(){try{const t=this.libSrc||`https://cdn.jsdelivr.net/npm/dashjs@${this.version}/dist/dash.all.min.js`,s=await u(t,"dashjs");this.dash=s.MediaPlayer(this.config).create(),this.dash.initialize(this.mediaEl,null,this.autoplay),this.dash.setTextDefaultEnabled(this.enableTextTracksByDefault),this.dash.enableForcedTextStreaming(!this.shouldRenderNativeTextTracks),this.dash.on(s.MediaPlayer.events.PLAYBACK_METADATA_LOADED,(()=>{this.dispatch("mediaType",o.Video),this.dispatch("currentSrc",this.src),this.dispatchLevels(),this.listenToTextTracksForChanges(),this.dispatch("playbackReady",!0)})),this.dash.on(s.MediaPlayer.events.TRACK_CHANGE_RENDERED,(()=>{this.shouldRenderNativeTextTracks||this.hideCurrentTextTrack()})),this.dash.on(s.MediaPlayer.events.ERROR,(t=>{this.vmError.emit(t)})),this.hasAttached=!0}catch(t){this.vmError.emit(t)}}async destroyDash(){this.dash?.reset(),this.hasAttached=!1}async onMediaElChange(t){this.destroyDash(),e(t.detail)||(this.mediaEl=t.detail,await this.setupDash())}levelToPlaybackQuality(t){return-1===t?"Auto":t.height+"p"}findLevelIndexFromQuality(t){return this.dash.getBitrateInfoListFor("video").findIndex((s=>this.levelToPlaybackQuality(s)===t))}dispatchLevels(){try{const t=this.dash.getBitrateInfoListFor("video");t?.length>0&&(this.dispatch("playbackQualities",["Auto",...t.map(this.levelToPlaybackQuality)]),this.dispatch("playbackQuality","Auto"))}catch(t){this.vmError.emit(t)}}listenToTextTracksForChanges(){if(this.textTracksDisposal.empty(),e(this.mediaEl)||this.shouldRenderNativeTextTracks)return;const t=this.dash?.getCurrentTrackFor("text")?.index-1??-1;this.currentTextTrack=t,this.dispatch("currentTextTrack",t),this.textTracksDisposal.add(r(this.mediaEl.textTracks,"change",this.onTextTracksChange.bind(this)))}getTextTracks(){return Array.from(this.mediaEl?.textTracks??[])}hideCurrentTextTrack(){const t=this.getTextTracks();t[this.currentTextTrack]&&this.isTextTrackVisible&&(t[this.currentTextTrack].mode="hidden")}onTextTracksChange(){this.hideCurrentTextTrack(),this.dispatch("textTracks",this.getTextTracks()),this.dispatch("isTextTrackVisible",this.isTextTrackVisible),this.dispatch("currentTextTrack",this.currentTextTrack)}async getAdapter(){const t=await(this.videoProvider?.getAdapter())??{},s=t.canPlay;return{...t,getInternalPlayer:async()=>this.dash,canPlay:async t=>c(t)&&d.test(t)||(s?.(t)??!1),canSetPlaybackQuality:async()=>{try{return this.dash?.getBitrateInfoListFor("video")?.length>0}catch(t){return this.vmError.emit(t),!1}},setPlaybackQuality:async t=>{if(!e(this.dash)){const s=this.findLevelIndexFromQuality(t);this.dash.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:-1===s}}}}),s>=0&&this.dash.setQualityFor("video",s),this.dispatch("playbackQuality",t)}},setCurrentTextTrack:async s=>{this.shouldRenderNativeTextTracks?t.setCurrentTextTrack(s):(this.currentTextTrack=s,this.dash?.setTextTrack(s),this.onTextTracksChange())},setTextTrackVisibility:async s=>{this.shouldRenderNativeTextTracks?t.setTextTrackVisibility(s):(this.isTextTrackVisible=s,this.dash?.enableText(s),this.onTextTracksChange())}}}render(){return i("vm-video",{willAttach:!0,crossOrigin:this.crossOrigin,preload:this.preload,poster:this.poster,controlsList:this.controlsList,autoPiP:this.autoPiP,disablePiP:this.disablePiP,hasCustomTextManager:!this.shouldRenderNativeTextTracks,disableRemotePlayback:this.disableRemotePlayback,mediaTitle:this.mediaTitle,ref:t=>{this.videoProvider=t}})}static get watchers(){return{src:["onSrcChange"],hasAttached:["onSrcChange"],shouldRenderNativeTextTracks:["onShouldRenderNativeTextTracks"],isTextTrackVisible:["onTextTrackChange"],currentTextTrack:["onTextTrackChange"]}}};p.style=":host{z-index:var(--vm-media-z-index)}";export{p as vm_dash}